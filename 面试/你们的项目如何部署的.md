

基于K8s的云平台部署


首先搭建流水线

```
代码下载 指定代码gitlab地址
代码检查 指定代码检查工具
代码编译 基于maven命令编译代码是否有编译错误 可以选择是否要允许测试
镜像制作 基于模板的Dockerfile
镜像部署 编写k8s的yaml文件
```


```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    workload.user.cattle.io/workloadselector: deployment-agriculture-beta-wisdom-agriculture-pub
  name: wisdom-agriculture-pub-deployment
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      workload.user.cattle.io/workloadselector: deployment-agriculture-beta-wisdom-agriculture-pub
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
template:
    metadata:
      labels:
        workload.user.cattle.io/workloadselector: deployment-agriculture-beta-wisdom-agriculture-pub
    spec:
      containers:
      - command:
        - java
        - -Djava.security.egd=file:/dev/./urandom
        - -Dskywalking.trace.ignore_path=/eureka/**
        - -Dskywalking.agent.namespace=agriculture-beta
        - -javaagent:/agent/skywalking-agent.jar
        - -jar
        - -Xms1024m
        - -Xmx2048m
        - /app.jar
        - --app.id=wisdom-agriculture-pub
        - --apollo.meta=http://172.10.30.92:8083
        - --apollo.bootstrap.namespaces=application.properties,application.yml
        - --apollo.bootstrap.enabled=true
        - --env=BETA
        env:
        - name: SW_AGENT_COLLECTOR_BACKEND_SERVICES
          value: 10.39.61.94:13800,10.39.61.92:13800,10.39.61.93:13800
        - name: SW_AGENT_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: ZVOS_PRJ_ENV
          value: beta
        - name: ZVOS_PRJ_NAME
          value: agriculture
        - name: ZVOS_PRJ_SRV_NAME
          value: wisdom-agriculture-pub-deployment
        image: <CICD_IMAGE>
        imagePullPolicy: Always
        name: wisdom-agriculture-pub
        ports:
        - containerPort: 10000
        volumeMounts:
        - mountPath: /logs
          name: logs
          subPath: ''
      - args:
        - -c
        - /usr/share/filebeat/conf/filebeat.yml
        - -e
        env:
        - name: ZVOS_PRJ_ENV
          value: beta
        - name: ZVOS_PRJ_NAME
          value: agriculture
        - name: ZVOS_PRJ_SRV_NAME
          value: wisdom-agriculture-pub-deployment
        image: harbor.zvos.zoomlion.com/elastic/filebeat:7.10.0
        imagePullPolicy: IfNotPresent
        name: filebeat
        volumeMounts:
        - mountPath: /usr/share/filebeat/conf/inputs.d
          name: inputs
          subPath: ''
        - mountPath: /usr/share/filebeat/conf
          name: filebeat
          subPath: ''
        - mountPath: /logs
          name: logs
          subPath: ''
      dnsPolicy: ClusterFirst
      hostAliases:
      - hostnames:
        - cdhargdev136
        ip: 192.168.200.136
      - hostnames:
        - cdhargdev137
        ip: 192.168.200.137
      - hostnames:
        - cdhargdev138
        ip: 192.168.200.138
      imagePullSecrets:
      - name: agriculture-harbor
      volumes:
      - configMap:
          items:
          - key: filebeat.yml
            path: filebeat.yml
          name: filebeat
        name: filebeat
      - emptyDir: {}
        name: logs
      - configMap:
          name: wisdom-agriculture-pub-deployment-inputs
        name: inputs

---
apiVersion: v1
kind: Service
metadata:
  name: wisdom-agriculture-pub-service # <4> 服务名称（必填）
spec:
  
  ports:
  - port: 10000  # <3> 服务端口（必填）
    targetPort: 10000  # <2> 容器端口（必填）
    
  selector:
    workload.user.cattle.io/workloadselector: deployment-agriculture-beta-wisdom-agriculture-pub # <1> 资源标签（必填）
---



---
apiVersion: v1
kind: ConfigMap
metadata:
  name: wisdom-agriculture-pub-deployment-inputs
data:
  api-input.yml: |-
    - type: log
      enabled: true
      paths:
        - /logs/api/*.log
      fields:
        kafka_topics: api
        environment_name: '\${ZVOS_PRJ_ENV}'
        project_name: '\${ZVOS_PRJ_NAME}'
        service_name: '\${ZVOS_PRJ_SRV_NAME}'
        pod_name: '\${HOSTNAME}'
      json.keys_under_root: true
  jvm-input.yml: |-
    - type: log
      enabled: true
      paths:
        - /logs/jvm/*.log
      fields:
        kafka_topics: jvm
        environment_name: '\${ZVOS_PRJ_ENV}'
        project_name: '\${ZVOS_PRJ_NAME}'
        service_name: '\${ZVOS_PRJ_SRV_NAME}'
        pod_name: '\${HOSTNAME}'
      json.keys_under_root: true
  log-input.yml: |-
    - type: log
      enabled: true
      paths:
        - /logs/app/*.log
      fields:
        kafka_topics: app
        environment_name: '\${ZVOS_PRJ_ENV}'
        project_name: '\${ZVOS_PRJ_NAME}'
        service_name: '\${ZVOS_PRJ_SRV_NAME}'
        pod_name: '\${HOSTNAME}'
      json.keys_under_root: true
---



---
apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat
data:
  filebeat.yml: |-
    filebeat.config.inputs:
      enabled: true
      path: conf/inputs.d/*.yml
      reload.enabled: true
      reload.period: 2s
    output.kafka:
      hosts: [10.39.61.92:9092","10.39.61.93:9092","10.39.61.94:9092]
      topic: 'micro-%{[fields.kafka_topics]}-log-%{[fields.environment_name]}'
      partition.hash:
        reachable_only: false

```