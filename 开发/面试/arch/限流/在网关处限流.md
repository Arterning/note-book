
在 Spring Cloud Gateway 网关层限流，可以借助 Sentinel 等限流框架来实现，它的实现步骤如下。

首先，在 pom.xml 中添加 Gateway 和 Sentinel 相关依赖，如下所示：



配置限流相关的规则，如下示例所示：

```yaml
spring:
  application:
    name: gate-way-blog
  cloud:
    sentinel:
      transport:
        dashboard: localhost:18080
      scg: # 配置限流之后，响应内容
        fallback:
          # 两种模式，一种是 response 返回文字提示信息，
          # 另一种是 redirect 重定向跳转，不过配置 redirect 也要配置对应的跳转的 uri
          mode: response
          # 响应的状态
          response-status: 200
          # 响应体
          response-body: '{"code": -10,"message": "被熔断或限流！"}'
```


最后在 Sentinel 控制台配置网关的限流设置即可，当然也可以使用 Nacos 作为数据源，两者选择配置其中一个即可。



### Nginx 限流

Nginx 提供了两种限流手段：

- 通过控制速率来实现限流。
- 通过控制并发连接数来实现限流。

我们一个一个来看。

#### 3.1 控制速率实现限流

我们需要使用 limit_req_zone 用来限制单位时间内的请求数，即速率限制，示例配置如下：

```
limit_req_zone $binary_remote_addr zone=mylimit:10m rate=2r/s; server { location / { limit_req zone=mylimit; } }
```

以上配置表示，限制每个 IP 访问的速度为 2r/s，因为 Nginx 的限流统计是基于毫秒的，我们设置的速度是 2r/s，转换一下就是 500ms 内单个 IP 只允许通过 1 个请求，从 501ms 开始才允许通过第 2 个请求。


#### 3.2 **控制并发数实现限流**

利用 limit_conn_zone 和 limit_conn 两个指令即可控制并发数，示例配置如下：

```xml
limit_conn_zone $binary_remote_addr zone=perip:10m;
limit_conn_zone $server_name zone=perserver:10m;
server {
  ...
  limit_conn perip 10;
  limit_conn perserver 100;
}
```

其中 limit_conn perip 10 表示限制单个 IP 同时最多能持有 10 个连接；limit_conn perserver 100 表示 server 同时能处理并发连接的总数为 100 个。