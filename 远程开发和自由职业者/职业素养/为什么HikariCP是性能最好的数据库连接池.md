为什么HikariCP是性能最好的数据库连接池？

原创 码农翻身刘欣  码农翻身  2019-12-27
“
这世界上已经有了这么多的、开源的数据库连接池， 为什么要再写一个？


1




这位老兄叫做Brett Wooldridge， 1989年毕业于新奥尔良洛约拉大学，计算机学士（你没看错，确实是1989年毕业的！），是一个生活在日本的美国人。

Brett一直默默无闻，直到他推出了HikariCP。

Hikari在日语中是“光”的意思，也就是说，这个连接池速度像“光”一样快。

HikariCP确实很快，在性能上碾压C3P0,DBCP2, Tomcat JDBC Pool 等一众连接池：





有了HikariCP这样耀眼的明星，就连BoneCP这样已经很快的连接池都不再维护了，它的作者“哀伤”说：BoneCP曾经击败过C3P0,DBCP这些老旧的连接池，但是为了支持HikariCP，可以放弃BoneCP了。



现在已经有很多公司在使用HikariCP了，HikariCP还成为了SpringBoot默认的连接池，伴随着SpringBoot和微服务，HikariCP 必将迎来广泛的普及。      


2


HikariCP 是怎么来的呢？

多年前，Brett 在开发一个产品原型，需要一个数据库连接池，像大多数开发人员一样，他Google了一个最流行的、最活跃的开源连接池。

很不幸的是，在对原型产品做压力测试的时候，他遇到了死锁问题，一些Exception表明线程之间的连接状态丢失了。

连接池是开源的，Brett把代码下载下来，试图找到并且Fix这些问题，然后贡献给社区。

但是当他开始阅读的时候，他发现这个连接池有几千行代码，远远超过他的预料。更要命的是有很多嵌套的锁，在一个地方获取，在很远的地方释放。在这样混乱的代码中，即使Fix了他遇到的问题，还有很多隐藏的问题难以预料。

Brett换了一个连接池并且检查了代码，这次加锁的语义清晰了，但是代码量依然比他期待的多两倍，尤其是在把核心的连接池逻辑委托给另外一个库的情况下！

Brett研究了更多的连接池，他发现这些连接池都以各种各样的方式违反了JDBC的规范和约定，例如当连接关闭，清除警告，回滚事务时，它们不会关闭Statements,不会重置用户更改的属性（如隔离级别），从而导致下一个消费者获得“脏连接”。

他不仅“仰天长叹”：这是真的吗？这就是Java发展20年后，连接池的现状吗？

程序员就是这样，遇到不爽的代码，还不如自己卷起袖子自己作一个， Talk is cheap ,show me the code ！

这个连接池就是HikariCP，极致的性能让它拥有了良好的口碑，受到了越来越多用户的欢迎。


3


为什么HikariCP能这么快呢？ 这要归功于Brett把事情做到极致的思路。

Brett深入到了字节码级别，他研究了程序编译出的字节码，甚至JIT编译出的汇编，以便使得关键的代码例程小于JIT内联阈值，他简化了继承层次结构，隐藏了成员变量，消除了强制类型转换。

他还做了很多微优化，其中一个就是不使用ArrayList，而是自己实现了一个叫FastList的类。因为ArrayList的get(int index)方法会对index做范围检查，而在HikariCP中，是可以确保index是合法的，范围检查是不必要的。

另外ArrayList 的remove(Object)方法会执行一个从头到尾的扫描，实际上JDBC的编程实践中在使用完Statement以后会马上关闭，或者以打开的相反次序来关闭，在这种情况下，从尾部扫描更好，于是ArrayList<Statement>被替换为自定义类FastList，这样就消除了这些额外开销。

HikariCP 还提供了一个自定义的无锁的ConcurrentBag，实现了高度的并发和极端的低延迟。

HikariCP 使用Javassist来生成Connection, Statement,和ResultSet的代理，在字节码中有getstatic 和invokevirtual 这样的指令，经过代码优化，它们被替换成了invokestatic ，这个指令更便于JVM去做更底层的优化。

这个优化甚至把栈帧中的栈深度从5降到了4，减少了push和pop指令。

你看看，Brett可真是“锱铢必较”，榨干了每一个字节，这种精神好像在上世纪80年代，做DOS开发的程序员才可能拥有（Brett正好是89年毕业的），现在有了大容量的内存，更快的CPU，富裕了之后，大家已经忘记了曾经的窘境了。

正是这样一点点微小的优化，凝聚溪流，汇集成河，让HikariCP获得了“光速的”性能，让人佩服，我估计后来者很难超越了吧。

参考资料：
Jooq对Brett的采访：
https://dzone.com/articles/jooq-tuesdays-what-it-takes-to-write-the-fastest-java-connection-pool
https://www.linkedin.com/in/brett-wooldridge-b6181b/
https://github.com/brettwooldridge/HikariCP-benchmark
https://github.com/brettwooldridge/HikariCP/wiki/Down-the-Rabbit-Hole
https://github.com/brettwooldridge/HikariCP/issues/232

往期精彩回顾
我是一个线程
我是一个Java Class
面向对象圣经
函数式编程圣经
TCP/IP之大明邮差
CPU阿甘
我是一个网卡
我是一个路由器
一个故事讲完HTTPs
编程语言的巅峰
Java：一个帝国的诞生
JavaScript：一个屌丝的逆袭
负载均衡的原理


码农翻身刘欣
喜欢作者
6 人喜欢

阅读 1.0万
 在看130

写下你的留言
精选留言
 28
友元

 Druid和HikariCP，我选HikariCP，慢SQL监控本来就应该让数据库监控去做，而不是Java应用层来做，不要把什么功能都往应用层上堆，连接池做好自己该做的事情就行了
 26
Tengdw

 Druid并没有HikariCP快，它更注重监控
 16
闵昊

 要是作者用上了 Druid 或许就不会开发 Hikari 了
 2
作者
 有可能
 10
十八画生

 大家好，我毕业于新奥尔良洛约拉大学烤鸡翅专业，Brett老兄在上大学期间吃了我烤的鸡翅，才有灵感写出了
HikariCP.
 9
金明

 这才是真正的程序员，不是只会增删改查。
 6
任杰

 那个默认开源连接池死锁的问题，我在大三的时候解决师兄留下的选题系统死锁的时候遇到了。师兄的系统留给几个师弟接手之后，上生产环境使用时出现同时上线不到100人就死锁，老师叫上我们好几个人连夜排查没排查出问题，也断点和单步都下不到死锁的地方，最后按照语义逻辑推理之后我猜测问题可能出在JDBC连接池上，换了连接池立马就好了。
一个连接池有问题坑了我一个通宵。
 5
作者
 这个经历很难得啊
 6
steven01997

 先用druid把问题都排除了，再换追光
 6
Coder_Xu

 Hikari，异度之刃2的光是不是这个
 5
李不言

 工匠精神
 4
布衣草莽

 Druid和Hikari的初衷是不一样的，Druid认为开发人员更容易写出慢sql，所以更注重sql执行时间的监控；Hikari就是觉得其它连接池的调度可以进一步优化
 4
Mr.Xie

 Druid好在哪里

作者
 监控啊
 4
apodemakeles

 HikariCP性能好还有一个原因：应对突发流量的处理方式和同类框架不同
 4
修身

 匠心
 3
EricZ

 先用druid把问题都排除了，再换追光，这个思路可以，哈哈哈哈(ಡωಡ)hiahiahia
 1
sam3125C

 这个源码得是Java写的吧？可以研究一下。
 1
作者
 就是java啊
 1
姚俊

 druid侧重监控，速度必然会慢一点点，所以要看性能，出一个druid和HikariCP的测评就够了，快多少？会成为技术选型的一个重点指标。个人观点，有限范围内的妥协如果能带来更大的好处，何乐不为
 1
韩宁

 Druid是平衡之选，追光是极致之选，两者是各有千秋，之前温少还和追光作者在github上battle来着，最终两人平手。。。。对于我来说，Druid还是比较香一些，生产环境查效率很快就定位了问题(数据量少测试环境看不出问题。。。)。用追光我估计就要抓瞎了
 1
姜川

 我一直以为数据库连接池就负责管理tcp连接的，至于锁什么的都是连接所执行的操作，没想到数据库连接池要干这么多事情，这是要逆天吗……
 1
李新杰

 看到这位老哥对待事物的认真态度，真的值得尊敬。在任何事情上，只要真心付出，肯定会有与之匹配的收获。

Kepler

 比druid还强吗
 1
作者
 各有侧重，druid监控很牛
 1
大炜

 把事情做到极致的力量
 1
股往

 Druid表示不服

网络天下美女

 还真没有研究过这个!

QQ怪

 只有我一个人之前用druid从来没用监控吗？

云师兄

 这种深入到虚拟机层次，去优化代码性能的极客精神绝对值得学习啊

刘强

 这种工匠精神估计和生活在日本有关。

技术宅星云

 由此观之，伟大的程序员都是被坑出来的。

踩的坑多了，绝望了，就弃坑重造成神了。

小翟

 昨天才把公司项目连接池从druid换成这个

你、我们

 今天第一次听说  孤陋寡闻了

博闻强识@达文西

 springboot的连接池是hikaricp，学到了

没有好使的磨棍

 PHPER表示想拥有。

现实、太美妙
